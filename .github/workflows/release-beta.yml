name: Release Beta with Changesets

# This workflow publishes beta versions on push to break/* branches
# Beta versions follow the pattern: X.Y.Z-beta.N (e.g., 2.0.0-beta.48)
# Uses Changesets for version management
#
# Required secrets:
# 1. NPM_TOKEN: NPM automation token for publishing packages
# 2. RELEASE_TOKEN: GitHub PAT with bypass permissions

on:
  push:
    branches:
      - 'break/**'

permissions:
  contents: write
  pull-requests: write
  packages: write
  actions: read
  id-token: write # Required for NPM provenance

jobs:
  release-beta:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          echo "Installing dependencies with pnpm..."
          pnpm --version
          pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Get latest commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "Commit message: $COMMIT_MSG"

      - name: Create beta changeset
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.message }}"

          # Clean commit message for changeset summary
          SUMMARY=$(echo "$COMMIT_MSG" | sed -E 's/^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|break|breaking)(\([^)]+\))?!?:\s*//')

          # Create changeset file
          CHANGESET_ID=$(date +%s)
          CHANGESET_FILE=".changeset/beta-$CHANGESET_ID.md"

          echo "---" > $CHANGESET_FILE
          echo "\"@kubit-ui-web/react-charts\": major" >> $CHANGESET_FILE
          echo "---" >> $CHANGESET_FILE
          echo "" >> $CHANGESET_FILE
          echo "$SUMMARY" >> $CHANGESET_FILE

          echo "âœ… Created beta changeset:"
          cat $CHANGESET_FILE

      - name: Enter prerelease mode
        run: |
          echo "ðŸ“¦ Checking prerelease mode status..."

          # Check if already in pre mode
          if [ -f ".changeset/pre.json" ]; then
            echo "âš ï¸ Already in prerelease mode, exiting first..."
            pnpm changeset pre exit

            # Commit the exit
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            if ! git diff --staged --quiet; then
              git commit -m "chore: exit prerelease mode [skip ci]"
            fi
          fi

          echo "ðŸ“¦ Entering beta prerelease mode..."
          pnpm changeset pre enter beta

      - name: Version packages
        run: |
          echo "ðŸ“¦ Versioning packages for beta..."
          pnpm changeset:version

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Commit version changes
          git add .
          if git diff --staged --quiet; then
            echo "No version changes to commit"
          else
            git commit -m "chore: version packages for beta [skip ci]"
            git push origin ${{ github.ref_name }}
          fi

      - name: Build packages
        run: |
          echo "ðŸ—ï¸ Building packages..."
          pnpm dist
        env:
          NODE_ENV: production

      - name: Publish beta to NPM
        run: |
          echo "ðŸš€ Publishing beta to NPM..."
          pnpm changeset:publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Exit prerelease mode
        run: |
          echo "ðŸ“¦ Exiting beta prerelease mode..."
          pnpm changeset pre exit

          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: exit beta prerelease mode [skip ci]"
            git push origin ${{ github.ref_name }}
          fi

      - name: Get published version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const npmLink = `https://www.npmjs.com/package/@kubit-ui-web/react-charts/v/${version}`;

            let comment = '## ðŸš€ Beta Package Published\n\n';
            comment += '**Branch:** `${{ github.ref_name }}`\n\n';
            comment += '| Package | Version | NPM Link |\n';
            comment += '|---------|---------|----------|\n';
            comment += `| @kubit-ui-web/react-charts | \`${version}\` | [View on NPM](${npmLink}) |\n`;
            comment += '\nâœ… Beta package has been successfully published to NPM!\n\n';
            comment += '**Install beta version:**\n';
            comment += '```sh\n';
            comment += `pnpm add @kubit-ui-web/react-charts@${version}\n`;
            comment += '```';

            // Try to find an open PR for this branch
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${{ github.ref_name }}`,
              state: 'open'
            });

            if (prs.data.length > 0) {
              await github.rest.issues.createComment({
                issue_number: prs.data[0].number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
